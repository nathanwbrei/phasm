# This is a singularity definition file
# On your OWN MACHINE, build it with `sudo singularity build <sif_name>.sif <def_name>.def`
#
# In JLAB network, there would be SSL problem during the building process.
# No problem with singularity remote GUI build.
#
# Ref: https://docs.sylabs.io/guides/3.7/user-guide/definition_files.html

BootStrap: docker
From: ubuntu:jammy

%post
    # install general software
    apt-get update && \
    apt-get -y install --no-install-recommends \
        apt-transport-https \
        ca-certificates \
        gnupg \
        software-properties-common \
        wget \
        git \
        cmake \
        build-essential \
        libtool \
        autoconf \
        unzip \
        vim \
        curl \
        gdb \
        libasan6 \
        less \
        exa \
        bat \
        valgrind \
        xz-utils \
        libexpat-dev \
        zlib1g-dev  # zlib for pin or libdwarf

    # Certs nonsense
    echo "check_certificate = off" >> ~/.wgetrc
    wget http://pki.jlab.org/JLabCA.crt -O /usr/local/share/ca-certificates/JLabCA.crt
    chmod 644 /usr/local/share/ca-certificates/JLabCA.crt
    update-ca-certificates

    # Geant4
    mkdir /deps
    cd /deps
    wget https://gitlab.cern.ch/geant4/geant4/-/archive/v11.0.2/geant4-v11.0.2.tar.gz
    tar xf geant4-v11.0.2.tar.gz
    cd geant4-v11.0.2
    mkdir build
    cd build
    cmake .. -DCMAKE_INSTALL_PREFIX=/deps/geant4
    make -j8 install

    # clean apt lists and install/build packages
    apt-get clean
    rm -rf /deps/*.xz /deps/*.gz /deps/libtorch-*.zip /deps/JANA2/build /deps/libdwarf/build
    rm -rf /var/lib/apt/lists/*

%environment
    # add cmake-specific configurations
    export CC=`which gcc`
    export CXX=`which g++`

%labels
    Author nbrei@jlab.org
    Version v0.0.1
    MyLabel dev

%help
    A container built upon docker://nvidia/cuda:11.8.0-cudnn8-devel-ubuntu22.04.
    Then this definition file installed libtorch, pin, dwarf, JANA etc at /deps.
    The built container is about 6.5 GB.
